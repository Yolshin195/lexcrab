<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LexCrab ‚Äî Smart Reading</title>
    <style>
        :root {
            --bg-main: #f8f9fa;
            --bg-card: #ffffff;
            --bg-sidebar: #ffffff;
            --accent: #f46623;
            --accent-hover: #d5531a;
            --text-primary: #1a1a1b;
            --text-secondary: #65676b;
            --border: #e4e6eb;
            --word-bg: #f0f2f5;
            --word-translated: #fff0e6;
            --shadow: 0 2px 10px rgba(0,0,0,0.06);
            --rust-black: #282c34;
            --overlay: rgba(0,0,0,0);
        }

        [data-theme="dark"] {
            --bg-main: #121212;
            --bg-card: #1e1e1e;
            --bg-sidebar: #1e1e1e;
            --accent: #f46623;
            --accent-hover: #ff7e42;
            --text-primary: #e4e6eb;
            --text-secondary: #b0b3b8;
            --border: #3a3b3c;
            --word-bg: #3a3b3c;
            --word-translated: #3d2b22;
            --shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            height: 100vh;
            display: flex;
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background 0.3s;
            overflow: hidden;
        }

        /* --- Layout --- */
        #editor { flex: 1; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.5rem; transition: filter 0.3s; }
        #sidebar { width: 380px; background: var(--bg-sidebar); border-left: 1px solid var(--border); display: flex; flex-direction: column; z-index: 1000; box-shadow: -4px 0 15px rgba(0,0,0,0.03); }

        /* --- Components --- */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        h1 { font-size: 1.6rem; margin: 0; color: var(--accent); font-weight: 800; letter-spacing: -1px; }

        .card { background: var(--bg-card); border-radius: 16px; padding: 1.5rem; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; }
        
        textarea { width: 100%; height: 110px; background: var(--bg-main); border: 1px solid var(--border); border-radius: 12px; padding: 14px; color: var(--text-primary); font-size: 1rem; resize: none; outline: none; transition: border-color 0.2s; }
        textarea:focus { border-color: var(--accent); }

        /* --- –ö–Ω–æ–ø–∫–∏ –∏ –°–µ—Ç–∫–∞ --- */
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
        button { padding: 12px 20px; border-radius: 10px; border: none; background: var(--accent); color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; font-size: 0.95rem; justify-content: center; }
        button:hover { background: var(--accent-hover); transform: translateY(-1px); }
        button.secondary { background: transparent; color: var(--text-primary); border: 1px solid var(--border); }
        
        .btn-main { flex: 2 !important; }
        .btn-side { flex: 1; }

        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞–º–∏ */
        .delete-btn, .speak-btn { 
            position: absolute; top: 12px; background: transparent; color: var(--text-secondary); 
            padding: 5px; opacity: 0; transition: all 0.2s; border: none; cursor: pointer;
        }
        .delete-btn { right: 12px; }
        .speak-btn { right: 45px; font-size: 1.1rem; }
        
        .text-block:hover .delete-btn, .text-block:hover .speak-btn { opacity: 1; }
        .delete-btn:hover { color: #ff4d4d; background: #fff1f1; border-radius: 6px; }
        .speak-btn:hover { color: var(--accent); background: var(--word-bg); border-radius: 6px; }

        .close-sidebar-btn { display: none; background: var(--bg-main); color: var(--text-primary); padding: 8px; border-radius: 50%; width: 36px; height: 36px; justify-content: center; align-items: center; position: absolute; right: 16px; top: 16px; border: 1px solid var(--border); font-size: 18px; z-index: 1001; }

        /* --- Word Styles --- */
        .text-block { line-height: 1.9; font-size: 1.1rem; }
        .word { cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: all 0.2s; border-bottom: 2px solid transparent; position: relative; }
        .word:hover { background: var(--word-bg); }
        .word.highlight { background: var(--accent) !important; color: white !important; border-radius: 6px; }
        .word.translated { border-bottom-color: var(--accent); background: var(--word-translated); }

        /* Tooltip */
        @media (hover: hover) {
            .word[data-translation]:not(.highlight):hover::after {
                content: attr(data-translation);
                position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%);
                background: var(--rust-black); color: white;
                padding: 6px 12px; border-radius: 8px; font-size: 0.85rem;
                white-space: nowrap; z-index: 1000; box-shadow: var(--shadow);
                animation: fadeIn 0.15s ease-out;
            }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(5px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

        /* --- Sidebar & GitHub Link --- */
        .panel-content { padding: 2rem; flex: 1; }
        .panel-nav { display: flex; padding: 12px; background: var(--bg-card); border-bottom: 1px solid var(--border); gap: 8px; padding-top: 50px; }
        .panel-nav button { flex: 1; background: transparent; color: var(--text-secondary); padding: 8px; }
        .panel-nav button.active { background: var(--bg-main); color: var(--accent); }

        .sidebar-footer { padding: 1.5rem; border-top: 1px solid var(--border); }
        .github-link {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            padding: 12px; border-radius: 12px; background: var(--word-bg);
            color: var(--text-primary); text-decoration: none; font-weight: 500;
            font-size: 0.9rem; transition: all 0.2s;
        }
        .github-link:hover { background: var(--border); transform: scale(1.02); }

        #selectedWordDisplay { font-size: 2.2rem; font-weight: 800; margin-bottom: 0.5rem; color: var(--accent); letter-spacing: -1px; word-break: break-word; }
        .dictionary-frame { width: 100%; text-decoration: none; color: var(--accent); font-weight: 600; display: flex; align-items: center; gap: 8px; margin-top: 1rem; padding: 1rem; border: 1px dashed var(--accent); border-radius: 12px; transition: background 0.2s; }
        .dictionary-frame:hover { background: var(--word-translated); }

        /* --- Mobile UX --- */
        @media (max-width: 768px) {
            #editor.blur { filter: blur(2px); pointer-events: none; }
            #sidebar { 
                position: fixed; bottom: 0; left: 0; width: 100%; height: 70vh; 
                transform: translateY(100%); border-radius: 24px 24px 0 0; border-left: none;
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            #sidebar.open { transform: translateY(0); box-shadow: 0 -10px 30px rgba(0,0,0,0.15); }
            .mobile-handle { width: 40px; height: 5px; background: var(--border); border-radius: 10px; margin: 12px auto; position: absolute; top: 0; left: 50%; transform: translateX(-50%); }
            .close-sidebar-btn { display: flex; }
            .delete-btn, .speak-btn { opacity: 1; }
            .panel-nav { padding-top: 60px; }
            
            .btn-group { display: grid; grid-template-columns: 1fr 1fr; }
            .btn-main { grid-column: span 2; }

            body::after {
                content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.4); z-index: 999; opacity: 0; pointer-events: none;
                transition: opacity 0.3s;
            }
            body.sidebar-open::after { opacity: 1; pointer-events: auto; }
        }
    </style>
</head>
<body data-theme="light">

<div id="editor" onclick="closeSidebar()">
    <div class="header-row">
        <h1>LexCrab<span style="color:var(--text-primary)">.</span></h1>
        <button class="secondary theme-toggle" onclick="event.stopPropagation(); toggleTheme()" style="padding: 10px;">üåì</button>
    </div>

    <div class="card" onclick="event.stopPropagation()">
        <textarea id="inputText" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é..."></textarea>
        <div class="btn-group">
            <button class="btn-main" onclick="addText()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
            <button class="secondary btn-side" onclick="exportJSON()">üì• –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button class="secondary btn-side" onclick="document.getElementById('importFile').click()">üì§ –ò–º–ø–æ—Ä—Ç</button>
            <input type="file" id="importFile" hidden onchange="importJSON(event)">
        </div>
    </div>

    <div id="textContainer"></div>
</div>

<div id="sidebar">
    <div class="mobile-handle"></div>
    <button class="close-sidebar-btn" onclick="closeSidebar()">‚úï</button>
    
    <div class="panel-nav">
        <button id="nav-trans" class="active" onclick="switchTab('trans')">–ü–µ—Ä–µ–≤–æ–¥</button>
        <button id="nav-dict" onclick="switchTab('dict')">–°–ª–æ–≤–∞—Ä—å</button>
    </div>

    <div id="trans-panel" class="panel-content">
        <div style="font-size: 0.8rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 1px; margin-bottom: 4px;">Selected Word</div>
        <div id="selectedWordDisplay">...</div>
        <input type="text" id="translationInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥..." 
               style="width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); margin-bottom: 1.5rem; font-size: 1rem; outline: none;">
        <button onclick="saveTranslation()" style="width: 100%; justify-content: center;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
    </div>

    <div id="dict-panel" class="panel-content" style="display:none">
        <h3>–í–Ω–µ—à–Ω–∏–µ —Ä–µ—Å—É—Ä—Å—ã</h3>
        <p style="color: var(--text-secondary); line-height: 1.6;">–ò–∑—É—á–∏—Ç–µ —Å–ª–æ–≤–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç–µ –±—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ–≤–æ–¥.</p>
        
        <a id="dictionaryLink" target="_blank" class="dictionary-frame">
            <span>Cambridge Dictionary</span> ‚Üó
        </a>
        
        <a id="googleTransLink" target="_blank" class="dictionary-frame" style="border-color: #4285f4; color: #4285f4; margin-top: 12px;">
            <span>Google Translate</span> ‚Üó
        </a>
    </div>

    <div class="sidebar-footer">
        <a href="https://github.com/Yolshin195/lexcrab" target="_blank" class="github-link">
            <svg height="20" viewBox="0 0 16 16" width="20" style="fill: currentColor;"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
            GitHub Repository
        </a>
    </div>
</div>

<script>
    let texts = JSON.parse(localStorage.getItem("lc_texts") || "[]");
    let translations = JSON.parse(localStorage.getItem("lc_trans") || "{}");
    let selectedWord = null;

    function toggleTheme() {
        const body = document.body;
        const newTheme = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        body.setAttribute('data-theme', newTheme);
        localStorage.setItem('lc_theme', newTheme);
    }
    if (localStorage.getItem('lc_theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

    function switchTab(tab) {
        document.getElementById('trans-panel').style.display = tab === 'trans' ? 'block' : 'none';
        document.getElementById('dict-panel').style.display = tab === 'dict' ? 'block' : 'none';
        document.getElementById('nav-trans').classList.toggle('active', tab === 'trans');
        document.getElementById('nav-dict').classList.toggle('active', tab === 'dict');
    }

    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('open');
        document.body.classList.remove('sidebar-open');
        document.getElementById('editor').classList.remove('blur');
    }

    function normalize(w) { return w.toLowerCase().replace(/[.,!?;:()]/g, ''); }

    // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ó–í–£–ß–ö–ò ---
    function speakText(text) {
        window.speechSynthesis.cancel(); // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ä–µ—á—å
        const utterance = new SpeechSynthesisUtterance(text);
        
        // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞: –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∏—Ä–∏–ª–ª–∏—Ü–∞ ‚Äî —Ä—É—Å—Å–∫–∏–π, –∏–Ω–∞—á–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
        const hasCyrillic = /[–∞-—è–ê-–Ø—ë–Å]/.test(text);
        utterance.lang = hasCyrillic ? 'ru-RU' : 'en-US';
        utterance.rate = 0.95; // –°–∫–æ—Ä–æ—Å—Ç—å —á—É—Ç—å –Ω–∏–∂–µ –æ–±—ã—á–Ω–æ–π
        
        window.speechSynthesis.speak(utterance);
    }

    function renderBlock(text, index) {
        const card = document.createElement("div");
        card.className = "card text-block";
        card.style.marginBottom = "1rem";
        card.onclick = (e) => e.stopPropagation();
        
        // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.innerHTML = "üóëÔ∏è";
        deleteBtn.onclick = (e) => { e.stopPropagation(); deleteBlock(index); };
        card.appendChild(deleteBtn);

        // –ö–Ω–æ–ø–∫–∞ –æ–∑–≤—É—á–∫–∏
        const speakBtn = document.createElement("button");
        speakBtn.className = "speak-btn";
        speakBtn.innerHTML = "üîä";
        speakBtn.onclick = (e) => { e.stopPropagation(); speakText(text); };
        card.appendChild(speakBtn);

        text.split(/(\s+)/).forEach(p => {
            if (/\s+/.test(p)) {
                card.appendChild(document.createTextNode(p));
            } else {
                const wordKey = normalize(p);
                const span = document.createElement("span");
                span.textContent = p;
                span.className = "word";
                span.dataset.word = wordKey;

                if (translations[wordKey]) {
                    span.classList.add("translated");
                    span.dataset.translation = translations[wordKey];
                }

                span.onclick = (e) => { e.stopPropagation(); selectWord(wordKey); };
                card.appendChild(span);
            }
        });
        document.getElementById("textContainer").prepend(card);
    }

    function addText() {
        const val = document.getElementById("inputText").value.trim();
        if (!val) return;
        texts.push(val);
        updateStorage();
        refreshBlocks();
        document.getElementById("inputText").value = "";
    }

    function deleteBlock(index) {
        texts.splice(index, 1);
        updateStorage();
        refreshBlocks();
    }

    function selectWord(word) {
        selectedWord = word;
        const encodedWord = encodeURIComponent(word);
        
        document.getElementById("selectedWordDisplay").textContent = word;
        document.getElementById("translationInput").value = translations[word] || "";
        
        document.getElementById("dictionaryLink").href = `https://dictionary.cambridge.org/dictionary/english/${encodedWord}`;
        document.getElementById("googleTransLink").href = `https://translate.google.com/?sl=auto&tl=ru&text=${encodedWord}&op=translate`;
        
        document.querySelectorAll(".word").forEach(w => w.classList.toggle("highlight", w.dataset.word === word));
        
        if (window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.add('open');
            document.body.classList.add('sidebar-open');
            document.getElementById('editor').classList.add('blur');
        }
    }

    function saveTranslation() {
        if (!selectedWord) return;
        const val = document.getElementById("translationInput").value.trim();
        if (val) {
            translations[selectedWord] = val;
        } else {
            delete translations[selectedWord];
        }
        localStorage.setItem("lc_trans", JSON.stringify(translations));
        refreshBlocks(); 
        if (window.innerWidth <= 768) closeSidebar();
    }

    function updateStorage() { localStorage.setItem("lc_texts", JSON.stringify(texts)); }
    function refreshBlocks() {
        document.getElementById("textContainer").innerHTML = "";
        texts.forEach((t, i) => renderBlock(t, i));
    }

    function exportJSON() {
        const blob = new Blob([JSON.stringify({ texts, translations })], {type: "application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `lexcrab_backup.json`;
        a.click();
    }

    function importJSON(e) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const data = JSON.parse(event.target.result);
            texts = data.texts || [];
            translations = data.translations || {};
            updateStorage();
            localStorage.setItem("lc_trans", JSON.stringify(translations));
            location.reload();
        };
        reader.readAsText(e.target.files[0]);
    }

    refreshBlocks();
</script>
</body>
</html>
