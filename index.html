<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LexCrab ‚Äî Smart Reading</title>
    <style>
        :root {
            --bg-main: #f8f9fa;
            --bg-card: #ffffff;
            --bg-sidebar: #ffffff;
            --accent: #f46623;
            --accent-hover: #d5531a;
            --text-primary: #1a1a1b;
            --text-secondary: #65676b;
            --border: #e4e6eb;
            --word-bg: #f0f2f5;
            --word-translated: #fff0e6;
            --shadow: 0 2px 10px rgba(0,0,0,0.06);
            --rust-black: #282c34;
            --overlay: rgba(0,0,0,0);
        }

        [data-theme="dark"] {
            --bg-main: #121212;
            --bg-card: #1e1e1e;
            --bg-sidebar: #1e1e1e;
            --accent: #f46623;
            --accent-hover: #ff7e42;
            --text-primary: #e4e6eb;
            --text-secondary: #b0b3b8;
            --border: #3a3b3c;
            --word-bg: #3a3b3c;
            --word-translated: #3d2b22;
            --shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            height: 100vh;
            display: flex;
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background 0.3s;
            overflow: hidden;
        }

        /* --- Layout --- */
        #editor { flex: 1; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.5rem; transition: filter 0.3s; }
        #sidebar { width: 380px; background: var(--bg-sidebar); border-left: 1px solid var(--border); display: flex; flex-direction: column; z-index: 1000; box-shadow: -4px 0 15px rgba(0,0,0,0.03); }

        /* --- Components --- */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        h1 { font-size: 1.6rem; margin: 0; color: var(--accent); font-weight: 800; letter-spacing: -1px; }

        .card { background: var(--bg-card); border-radius: 16px; padding: 1.5rem; box-shadow: var(--shadow); border: 1px solid var(--border); transition: transform 0.2s; position: relative; }
        .text-block:hover .delete-btn { opacity: 1; }

        textarea { width: 100%; height: 110px; background: var(--bg-main); border: 1px solid var(--border); border-radius: 12px; padding: 14px; color: var(--text-primary); font-size: 1rem; resize: none; outline: none; transition: border-color 0.2s; }
        textarea:focus { border-color: var(--accent); }

        button { padding: 12px 24px; border-radius: 10px; border: none; background: var(--accent); color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; font-size: 0.95rem; }
        button:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(244, 102, 35, 0.2); }
        button.secondary { background: transparent; color: var(--text-primary); border: 1px solid var(--border); }

        .delete-btn { position: absolute; top: 12px; right: 12px; background: transparent; color: var(--text-secondary); padding: 5px; opacity: 0; transition: opacity 0.2s; }
        .delete-btn:hover { color: #ff4d4d; background: #fff1f1; }

        .close-sidebar-btn { display: none; background: var(--bg-main); color: var(--text-primary); padding: 8px; border-radius: 50%; width: 36px; height: 36px; justify-content: center; align-items: center; position: absolute; right: 16px; top: 16px; border: 1px solid var(--border); font-size: 18px; z-index: 1001; }

        /* --- Word Styles --- */
        .text-block { line-height: 1.9; font-size: 1.1rem; }
        .word { cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: all 0.2s; border-bottom: 2px solid transparent; position: relative; }
        .word:hover { background: var(--word-bg); }
        .word.highlight { background: var(--accent) !important; color: white !important; border-radius: 6px; }
        .word.translated { border-bottom-color: var(--accent); background: var(--word-translated); }

        /* Tooltip */
        @media (hover: hover) {
            .word[data-translation]:not(.highlight):hover::after {
                content: attr(data-translation);
                position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%);
                background: var(--rust-black); color: white;
                padding: 6px 12px; border-radius: 8px; font-size: 0.85rem;
                white-space: nowrap; z-index: 1000; box-shadow: var(--shadow);
                animation: fadeIn 0.15s ease-out;
            }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(5px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

        /* --- Sidebar Panels --- */
        .panel-content { padding: 2rem; flex: 1; }
        .panel-nav { display: flex; padding: 12px; background: var(--bg-card); border-bottom: 1px solid var(--border); gap: 8px; padding-top: 50px; } /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è */
        .panel-nav button { flex: 1; background: transparent; color: var(--text-secondary); padding: 8px; }
        .panel-nav button.active { background: var(--bg-main); color: var(--accent); }

        #selectedWordDisplay { font-size: 2.2rem; font-weight: 800; margin-bottom: 0.5rem; color: var(--accent); letter-spacing: -1px; word-break: break-word; }
        .dictionary-frame { width: 100%; text-decoration: none; color: var(--accent); font-weight: 600; display: flex; align-items: center; gap: 8px; margin-top: 1rem; padding: 1rem; border: 1px dashed var(--accent); border-radius: 12px; }

        /* --- Mobile UX --- */
        @media (max-width: 768px) {
            #editor.blur { filter: blur(2px); pointer-events: none; }
            #sidebar { 
                position: fixed; bottom: 0; left: 0; width: 100%; height: 60vh; 
                transform: translateY(100%); border-radius: 24px 24px 0 0; border-left: none;
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            #sidebar.open { transform: translateY(0); box-shadow: 0 -10px 30px rgba(0,0,0,0.15); }
            .mobile-handle { width: 40px; height: 5px; background: var(--border); border-radius: 10px; margin: 12px auto; position: absolute; top: 0; left: 50%; transform: translateX(-50%); }
            .close-sidebar-btn { display: flex; }
            .delete-btn { opacity: 1; }
            .panel-nav { padding-top: 60px; }
            
            /* Overlay —ç—Ñ—Ñ–µ–∫—Ç */
            body::after {
                content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.4); z-index: 999; opacity: 0; pointer-events: none;
                transition: opacity 0.3s;
            }
            body.sidebar-open::after { opacity: 1; pointer-events: auto; }
        }
    </style>
</head>
<body data-theme="light">

<div id="editor" onclick="closeSidebar()">
    <div class="header-row">
        <h1>LexCrab<span style="color:var(--text-primary)">.</span></h1>
        <button class="secondary theme-toggle" onclick="event.stopPropagation(); toggleTheme()" style="padding: 10px;">üåì</button>
    </div>

    <div class="card" onclick="event.stopPropagation()">
        <textarea id="inputText" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é..."></textarea>
        <div class="btn-group">
            <button onclick="addText()">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
            <button class="secondary" onclick="exportJSON()">–≠–∫—Å–ø–æ—Ä—Ç</button>
            <button class="secondary" onclick="document.getElementById('importFile').click()">–ò–º–ø–æ—Ä—Ç</button>
            <input type="file" id="importFile" hidden onchange="importJSON(event)">
        </div>
    </div>

    <div id="textContainer"></div>
</div>

<div id="sidebar">
    <div class="mobile-handle"></div>
    <button class="close-sidebar-btn" onclick="closeSidebar()">‚úï</button>
    
    <div class="panel-nav">
        <button id="nav-trans" class="active" onclick="switchTab('trans')">–ü–µ—Ä–µ–≤–æ–¥</button>
        <button id="nav-dict" onclick="switchTab('dict')">–°–ª–æ–≤–∞—Ä—å</button>
    </div>

    <div id="trans-panel" class="panel-content">
        <div style="font-size: 0.8rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 1px; margin-bottom: 4px;">Selected Word</div>
        <div id="selectedWordDisplay">...</div>
        <input type="text" id="translationInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥..." 
               style="width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); margin-bottom: 1.5rem; font-size: 1rem; outline: none;">
        <button onclick="saveTranslation()" style="width: 100%; justify-content: center;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
    </div>

    <div id="dict-panel" class="panel-content" style="display:none">
        <h3>Cambridge English</h3>
        <p style="color: var(--text-secondary); line-height: 1.6;">–ò–∑—É—á–∏—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø—Ä–∏–º–µ—Ä—ã –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ.</p>
        <a id="dictionaryLink" target="_blank" class="dictionary-frame">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ —Å–ª–æ–≤–∞—Ä–µ ‚Üó</a>
    </div>
</div>

<script>
    let texts = JSON.parse(localStorage.getItem("lc_texts") || "[]");
    let translations = JSON.parse(localStorage.getItem("lc_trans") || "{}");
    let selectedWord = null;

    function toggleTheme() {
        const body = document.body;
        const newTheme = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        body.setAttribute('data-theme', newTheme);
        localStorage.setItem('lc_theme', newTheme);
    }
    if (localStorage.getItem('lc_theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

    function switchTab(tab) {
        document.getElementById('trans-panel').style.display = tab === 'trans' ? 'block' : 'none';
        document.getElementById('dict-panel').style.display = tab === 'dict' ? 'block' : 'none';
        document.getElementById('nav-trans').classList.toggle('active', tab === 'trans');
        document.getElementById('nav-dict').classList.toggle('active', tab === 'dict');
    }

    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('open');
        document.body.classList.remove('sidebar-open');
        document.getElementById('editor').classList.remove('blur');
        // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–ª–æ–≤–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        // document.querySelectorAll(".word").forEach(w => w.classList.remove("highlight"));
    }

    function normalize(w) { return w.toLowerCase().replace(/[.,!?;:()]/g, ''); }

    function renderBlock(text, index) {
        const card = document.createElement("div");
        card.className = "card text-block";
        card.onclick = (e) => e.stopPropagation(); // –ß—Ç–æ–±—ã –∫–ª–∏–∫ –ø–æ –±–ª–æ–∫—É –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª —Å–∞–π–¥–±–∞—Ä —Å—Ä–∞–∑—É
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.innerHTML = "üóëÔ∏è";
        deleteBtn.onclick = (e) => { e.stopPropagation(); deleteBlock(index); };
        card.appendChild(deleteBtn);

        text.split(/(\s+)/).forEach(p => {
            if (/\s+/.test(p)) {
                card.appendChild(document.createTextNode(p));
            } else {
                const wordKey = normalize(p);
                const span = document.createElement("span");
                span.textContent = p;
                span.className = "word";
                span.dataset.word = wordKey;

                if (translations[wordKey]) {
                    span.classList.add("translated");
                    span.dataset.translation = translations[wordKey];
                }

                span.onclick = (e) => { 
                    e.stopPropagation(); 
                    selectWord(wordKey); 
                };
                card.appendChild(span);
            }
        });
        document.getElementById("textContainer").prepend(card);
    }

    function addText() {
        const val = document.getElementById("inputText").value.trim();
        if (!val) return;
        texts.push(val);
        updateStorage();
        refreshBlocks();
        document.getElementById("inputText").value = "";
    }

    function deleteBlock(index) {
        texts.splice(index, 1);
        updateStorage();
        refreshBlocks();
    }

    function selectWord(word) {
        selectedWord = word;
        document.getElementById("selectedWordDisplay").textContent = word;
        document.getElementById("translationInput").value = translations[word] || "";
        document.getElementById("dictionaryLink").href = `https://dictionary.cambridge.org/dictionary/english/${word}`;
        
        document.querySelectorAll(".word").forEach(w => w.classList.toggle("highlight", w.dataset.word === word));
        
        if (window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.add('open');
            document.body.classList.add('sidebar-open');
            document.getElementById('editor').classList.add('blur');
        }
    }

    function saveTranslation() {
        if (!selectedWord) return;
        const val = document.getElementById("translationInput").value.trim();
        if (val) {
            translations[selectedWord] = val;
        } else {
            delete translations[selectedWord];
        }
        localStorage.setItem("lc_trans", JSON.stringify(translations));

        document.querySelectorAll(`.word[data-word="${selectedWord}"]`).forEach(w => {
            if (val) {
                w.classList.add("translated");
                w.dataset.translation = val;
            } else {
                w.classList.remove("translated");
                w.removeAttribute("data-translation");
            }
        });
        if (window.innerWidth <= 768) closeSidebar();
    }

    function updateStorage() { localStorage.setItem("lc_texts", JSON.stringify(texts)); }
    
    function refreshBlocks() {
        document.getElementById("textContainer").innerHTML = "";
        texts.forEach((t, i) => renderBlock(t, i));
    }

    function exportJSON() {
        const blob = new Blob([JSON.stringify({ texts, translations })], {type: "application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `lexcrab_data.json`;
        a.click();
    }

    function importJSON(e) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const data = JSON.parse(event.target.result);
            texts = data.texts || [];
            translations = data.translations || {};
            updateStorage();
            localStorage.setItem("lc_trans", JSON.stringify(translations));
            location.reload();
        };
        reader.readAsText(e.target.files[0]);
    }

    refreshBlocks();
</script>
</body>
</html>
